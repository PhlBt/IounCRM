<template>
  <v-row align="center" justify="center">
    <v-col cols="12" sm="8" md="3">
      <v-card
        class="elevation-12"
        v-if="confirmationResult === null">
        <v-toolbar class="d-flex justify-center" color="primary" dark dense flat>
          <v-toolbar-title>
            <v-icon class="mr-3">mdi-account-key-outline</v-icon>
            Авторизация
          </v-toolbar-title>
        </v-toolbar>
        <div>
          <v-card-text>
            <v-form ref="auth" @keyup.enter="auth()">
              <v-text-field
                v-model="phone"
                id="phone"
                label="Телефон"
                name="phone"
                prepend-icon="mdi-cellphone-key"
                type="phone"
                maxlength="12"
                :rules="rules.phone"
                @focus="phoneMask(true)"
                @blur="phoneMask(false)"
              ></v-text-field>
            </v-form>
          </v-card-text>
          <v-card-actions class="d-flex justify-center mb-3">
            <v-btn
              class="w-50"
              id="login-btn"
              color="primary"
              @click="auth()">
              Войти
            </v-btn>
          </v-card-actions>
        </div>
      </v-card>

      <v-card class="elevation-12" v-else>
        <v-toolbar color="primary" dark flat>
          <v-toolbar-title>Введите код из смс сообщения</v-toolbar-title>
        </v-toolbar>
        <v-card-text>
          <v-form @keyup.enter="codeConfirm()">
            <v-text-field
              v-model="code"
              id="code"
              label="Код"
              name="code"
            ></v-text-field>
          </v-form>
        </v-card-text>
        <v-card-actions class="d-flex justify-center mb-3">
          <v-btn 
            class="w-45"
            color="primary"
            @click="codeConfirm()">
            Подтвердить
          </v-btn>
          <v-btn
            class="w-45"
            color="error"
            @click="again()">
            Отменить
          </v-btn>
        </v-card-actions>
      </v-card>

    </v-col>
  </v-row>
</template>

<script>
import VueRecaptcha from "vue-recaptcha";

export default {
  layout: "thin",
  name: "login",
  components: { VueRecaptcha },
  data: function () {
    return {
      name: "",
      project: "",
      phone: "",
      code: "",
      captcha: null,
      confirmationResult: null,
      reg: false,

      rules: {
        name: [v => !!v || 'Имя необходимо заполнить'],
        project: [v => !!v || 'Проект необходимо заполнить'],
        phone: [v => !!v || 'Телефон необходимо заполнить']
      },
    };
  },
  mounted() {
    this.captcha = new this.$fireModule.auth.RecaptchaVerifier("login-btn", {
      size: "invisible",
    })
  },
  computed: {
    isAuth: function() {
      return this.$store.getters.isAuthed
    }
  },
  watch: {
    'isAuth': function() {
      if (this.isAuth)
        this.$router.push('/')
    }
  },
  methods: {
    auth: function () {
      if (!this.$refs['auth'].validate()) return
      this.$fire.auth
        .signInWithPhoneNumber(this.phone, this.captcha)
        .then((result) => {
          this.confirmationResult = result
        })
        .catch((error) => console.log(error))
    },
    codeConfirm: function () {
      this.confirmationResult
        .confirm(this.code)
        .catch((error) => console.log(error))
    },
    again: function () {
      this.confirmationResult = null
    },
    phoneMask: function (status) {
      if (status) {
        this.phone =
          this.phone.substring(0, 2) !== "+7" ? `+7${this.phone}` : this.phone
      } else {
        this.phone = this.phone.length > 2 ? this.phone : ""
      }
    },
  },
};
</script>

<style>
  input:-webkit-autofill,
  input:-webkit-autofill:hover,
  input:-webkit-autofill:focus input:-webkit-autofill,
  textarea:-webkit-autofill,
  textarea:-webkit-autofill:hover textarea:-webkit-autofill:focus,
  select:-webkit-autofill,
  select:-webkit-autofill:hover,
  select:-webkit-autofill:focus {
    border: 0;
    transition: background-color 5000s ease-in-out 0s;
    background: -webkit-linear-gradient(
      top,
      rgba(255, 255, 255, 0) 0%,
      rgba(0, 174, 255, 0.04) 50%,
      rgba(255, 255, 255, 0) 51%,
      rgba(0, 174, 255, 0.03) 100%
    );
    color: #ffffff !important;
    -webkit-text-fill-color: rgb(255, 255, 255);
  }
</style>